<html>
<head>
    <link rel="stylesheet" type="text/css" href="default.css" />
    <style>
        @page { size 11in 8.5in; margin: 2cm }
        div.page { page-break-after: always }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script>
        var queryString = window.location.href.slice(window.location.href.indexOf('?') + 1);

        $(document).ready(function() {
            $.ajax({
                url: getUrlParameter("target")+".php?" + queryString,  //'/tests/sample2',
                dataType: 'json',
                success: function (data, textStatus, jqXHR) {
                    // since we are using jQuery, you don't need to parse response
                    addTitle();
                    drawTable(data);
                    $('.loader').fadeOut("slow");
                }
            });
        });

        function addTitle(){
            var tableType = getUrlParameter("Submit");
            if(tableType && tableType.indexOf("Sales") >= 0){
                tableType = "Sales";
            } else if(getUrlParameter("style").indexOf("sales") >= 0) {
                tableType = "Sales";
            } else {
                tableType = "Equity";
            }

            $("#title").append("Comp " + tableType + " Grid - Five Stone - " + new Date($.now()));
        };

        function getUrlParameter(param){
            var params = queryString.split('&');
            for( var i =0; i < params.length; i++){
                var currParam = params[i].split('=');
                if(currParam[0] === param){
                    return currParam[1];
                }
            }
        };

        function drawTable(data) {
            var totalCol = data.compCount + 2; // one for desc column and one for subject
            totalComps = data.CompCount;
            drawHeader(data.compCount);
            for (var i = 0; i < data.rows.length; i++) {
                drawRow(data.rows[i], totalCol);
            }
        };

        function drawHeader(comps){
            var row = $("<tr />")
            $("#subjCompTable").append(row); //this will append tr element to table... keep its reference for a while since we will add cells into it
            row.append($("<th></th>")); // cell 0,0 empty
            row.append($("<th class='colhead'> Subject <div id='subject'/></th>"));
            for(var i=1; i <= comps; i++){ // Start count naturally
                row.append($("<th class='colhead'> Comp #" + i + "</th>"));
            }
        };

        function drawRow(rowData){
            var row = $("<tr />")
            $("#subjCompTable").append(row); //this will append tr element to table... keep its reference for a while since we will add cels into it
            var rowClass;
            $.each(rowData, function(key, value) {
                if(key === 'description'){
                    if(value) {
                        rowClass = value.replace(/ /g, '');
                        row.append($("<th>" + value + "</th>"));
                    } else {
                        row.append($("<td class='unknown'>&nbsp</td>"));
                    }
                } else if(value && typeof value == 'object'){
                    //We have a multi value cell
                    var cell = "<td>";
                    if(value.value !== null) {
                        cell += "<div class='value'>" + value.value + "</div>";
                    }
                    if(value.subvalue && value.subvalue !== null) {
                        cell += "<div class='subvalue'>" + value.subvalue + "</div>";
                    }
                    if(value.delta !== null) {
                        if(key !== 'col1') { // Don't display deltas in subject column
                            cell += "<div class='delta'>" + value.delta + "</div>";
                        }
                    }
                    cell += "</td>";
                    row.append($(cell));
                } else {
                    if(value !== null) {
                        if( rowClass === 'PropertyID'){
                            row.append($("<td class='" + rowClass + "'>" + value + "<button id='removeMe' onclick='removeMe("+value+")'/></td>"));
                        } else {
                            row.append($("<td class='" + rowClass + "'>" + value + "</td>"));
                        }
                    } else {
                        row.append($("<td/>"));
                    }
                }
            });
        };

        function removeMe(propId) {
            var params = queryString.split('&');
            var found = false;
            var newQueryString = '';
            for( var i =0; i < params.length; i++){
                var currParam = params[i].split('=');
                if(currParam[0] === 'exclude'){
                    currParam[1] = currParam[1] + '_' + propId;
                    found = true
                }
                newQueryString = newQueryString + currParam.join('=') + "&";
            }
            if(!found){
                newQueryString = params.join("&") + '&exclude=' + propId;
            }
            var newUrl = "resultSubjComps.html?"+ newQueryString;
            window.location.href = newUrl;
        };

    </script>
</head>
<body>
<div class="loader"></div>
<div class="page">
<h2><div id="title"/></h2>
<table id="subjCompTable">
</table>
</body>
</html>

